<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Troll Jump - Beta</title>
  <style>
    body {
      margin: 0;
      background: #111;
    }
    canvas {
      display: block;
      margin: auto;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser.min.js"></script>
</head>
<body>
  <script>
    const config = {
      type: Phaser.AUTO,
      width: 800,
      height: 600,
      backgroundColor: "#222",
      physics: {
        default: "arcade",
        arcade: {
          gravity: { y: 600 },
          debug: false
        }
      },
      scene: {
        preload,
        create,
        update
      }
    };

    let player, cursors;
    let platforms = [];
    let fakeZone, spikes, goal;
    let gameOver = false;
    let isWin = false;
    let restartText;

    const game = new Phaser.Game(config);

    function preload() {}

    function create() {
      // Crear plataforma visible
      const platformLeft = this.add.rectangle(250, 570, 300, 20, 0x888888);
      const platformRight = this.add.rectangle(550, 570, 300, 20, 0x888888);
      platforms.push(platformLeft, platformRight);
      platforms.forEach(p => {
        this.physics.add.existing(p, true); // true = est√°tica
      });

      // Jugador: rect√°ngulo vertical
      player = this.add.rectangle(100, 500, 20, 40, 0x00ffcc);
      this.physics.add.existing(player);
      player.body.setCollideWorldBounds(true);

      // Colisi√≥n con plataformas
      platforms.forEach(p => {
        this.physics.add.collider(player, p);
      });

      // Zona falsa en el centro
      fakeZone = this.add.zone(400, 570, 100, 20);
      this.physics.add.existing(fakeZone);
      fakeZone.body.setAllowGravity(false);
      fakeZone.body.moves = false;

      this.physics.add.overlap(player, fakeZone, () => {
        if (!gameOver && !isWin) {
          showSpikes(this);
        }
      });

      // P√∫as ocultas
      spikes = this.add.rectangle(400, 590, 100, 20, 0xff0000);
      this.physics.add.existing(spikes);
      spikes.visible = false;
      spikes.body.setAllowGravity(false);
      spikes.body.moves = false;

      // Colisi√≥n mortal con p√∫as
      this.physics.add.overlap(player, spikes, () => {
        if (!gameOver && !isWin) {
          gameOver = true;
          showDeathScreen(this);
        }
      });

      // Meta (puerta de salida)
      goal = this.add.rectangle(750, 530, 30, 60, 0x00ff00);
      this.physics.add.existing(goal, true);
      this.physics.add.overlap(player, goal, () => {
        if (!gameOver && !isWin) {
          isWin = true;
          showWinScreen(this);
        }
      });

      // Texto de muerte y victoria
      restartText = this.add.text(400, 250, "", { fontSize: "30px", fill: "#fff" }).setOrigin(0.5);

      // Controles
      cursors = this.input.keyboard.createCursorKeys();
    }

    function showSpikes(scene) {
      // Borrar la plataforma falsa
      platforms.forEach(p => p.destroy());
      platforms = [];
      spikes.visible = true;
    }

    function showDeathScreen(scene) {
      restartText.setText("¬°CA√çSTE EN LA TRAMPA! üíÄ\nPresiona R para reiniciar.");
      player.setFillStyle(0xff0000);
      scene.physics.pause();  // Asegurar que se llama correctamente dentro del contexto de la escena
    }

    function showWinScreen(scene) {
      restartText.setText("¬°GANASTE! üéâ\nPresiona R para reiniciar.");
      player.setFillStyle(0x00ff00);
      scene.physics.pause();  // Asegurar que se llama correctamente dentro del contexto de la escena
    }

    function update() {
      if (gameOver || isWin) {
        if (cursors.up.isDown) {
          // Reiniciar el juego al presionar R
          gameOver = false;
          isWin = false;
          restartText.setText("");
          this.scene.restart();
        }
        return;
      }

      const speed = 160;
      const jumpPower = -300;

      if (cursors.left.isDown) {
        player.body.setVelocityX(-speed);
      } else if (cursors.right.isDown) {
        player.body.setVelocityX(speed);
      } else {
        player.body.setVelocityX(0);
      }

      if (cursors.up.isDown && player.body.touching.down) {
        player.body.setVelocityY(jumpPower);
      }
    }
  </script>
</body>
</html>
